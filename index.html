<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web'de Desibel Ölçümü</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            text-align: center;
            margin-top: 50px;
        }
        .decibel {
            font-size: 48px;
            color: #333;
        }
    </style>
</head>
<body>
    <h1>Mikrofon Desibel Ölçer</h1>
    <p class="decibel">Desibel: 0 dB</p>
    <button id="startButton">Başlat</button>
    <button id="stopButton" disabled>Dur</button>

    <script>
        const startButton = document.getElementById('startButton');
        const stopButton = document.getElementById('stopButton');
        const decibelDisplay = document.querySelector('.decibel');

        let audioContext;
        let analyser;
        let microphone;
        let javascriptNode;
        let isRunning = false;

        startButton.addEventListener('click', async () => {
            if (isRunning) return;
            isRunning = true;

            try {
                // Mikrofon erişimi talebi
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });

                // Audio Context oluştur
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                analyser = audioContext.createAnalyser();
                microphone = audioContext.createMediaStreamSource(stream);
                javascriptNode = audioContext.createScriptProcessor(2048, 1, 1);

                analyser.smoothingTimeConstant = 0.8;
                analyser.fftSize = 2048;

                microphone.connect(analyser);
                analyser.connect(javascriptNode);
                javascriptNode.connect(audioContext.destination);

                javascriptNode.onaudioprocess = () => {
                    const array = new Uint8Array(analyser.frequencyBinCount);
                    analyser.getByteTimeDomainData(array);

                    let sum = 0;
                    for (let i = 0; i < array.length; i++) {
                        const amplitude = (array[i] - 128) / 128; // Normalize edilmiş değer
                        sum += amplitude * amplitude;
                    }
                    const rms = Math.sqrt(sum / array.length); // RMS hesaplama
                    const decibel = 20 * Math.log10(rms); // Desibel değeri

                    // Ekranda göster
                    decibelDisplay.textContent = `Desibel: ${decibel.toFixed(2)} dB`;
                };

                startButton.disabled = true;
                stopButton.disabled = false;
            } catch (error) {
                console.error('Mikrofona erişim başarısız:', error);
                alert('Mikrofona erişim izni vermelisiniz!');
                isRunning = false;
            }
        });

        stopButton.addEventListener('click', () => {
            if (!isRunning) return;
            isRunning = false;

            // Mikrofonu kapat
            javascriptNode.disconnect();
            analyser.disconnect();
            microphone.disconnect();
            audioContext.close();

            startButton.disabled = false;
            stopButton.disabled = true;
            decibelDisplay.textContent = 'Desibel: 0 dB';
        });
    </script>
</body>
</html>
